# Firebase Authentication Architecture - Flutter Implementation

This document describes the Firebase Authentication architecture for the Yuva marketplace platform.

---

## Overview

The Yuva platform consists of **two separate Flutter apps** that share a single Firebase project:

- **yuva_client** - Client app for people requesting cleaning services
- **yuva_worker** - Worker app for cleaning professionals offering services

Both apps use **Firebase Authentication** for user authentication and session management.

---

## Firebase Project Configuration

### Firebase Project Details

- **Project ID:** `yuve-es`
- **Project Number:** `83359937854`
- **Environment:** Production

### Registered Firebase Apps

| App         | Platform | Package Name            | App ID                                       |
| ----------- | -------- | ----------------------- | -------------------------------------------- |
| yuva_client | Android  | com.example.yuva        | 1:83359937854:android:88610e82fd8c03fceae86f |
| yuva_worker | Android  | com.example.yuva_worker | 1:83359937854:android:a29de44aa944fd1ceae86f |

### Configuration Files

**yuva_client:**

- `yuva_client/lib/firebase_options.dart` - Generated by FlutterFire CLI
- `yuva_client/android/app/google-services.json` - Android config (auto-downloaded)

**yuva_worker:**

- `yuva_worker/lib/firebase_options.dart` - Generated by FlutterFire CLI
- `yuva_worker/android/app/google-services.json` - Android config (auto-downloaded)

---

## Architecture

### Tech Stack

- **Framework:** Flutter 3.10+
- **State Management:** Riverpod 2.6.1
- **Firebase SDKs:**
  - `firebase_core: ^3.9.0`
  - `firebase_auth: ^5.3.4`

### Design Pattern

Both apps follow the **Repository Pattern** with **Riverpod** for dependency injection and state management.

---

## Code Structure

### yuva_client

```
yuva_client/lib/
├── firebase_options.dart              # Firebase config (auto-generated)
├── main.dart                          # App entry point, Firebase init
├── core/
│   └── providers.dart                 # Riverpod providers
├── data/
│   ├── models/
│   │   └── user.dart                  # User model
│   └── repositories/
│       ├── auth_repository.dart       # Auth interface
│       ├── firebase_auth_repository.dart  # Firebase impl
│       └── auth_state_notifier.dart   # Auth state notifier
└── features/
    └── auth/
        ├── login_screen.dart          # Login UI
        └── signup_screen.dart         # Sign up UI
```

### yuva_worker

```
yuva_worker/lib/
├── firebase_options.dart              # Firebase config (auto-generated)
├── main.dart                          # App entry point, Firebase init
├── core/
│   └── providers.dart                 # Riverpod providers
├── data/
│   ├── models/
│   │   ├── user.dart                  # User model (Firebase Auth)
│   │   └── worker_profile.dart        # Worker profile (Firestore - future)
│   └── repositories/
│       ├── auth_repository.dart       # Auth interface
│       ├── firebase_auth_repository.dart  # Firebase impl
│       └── auth_state_notifier.dart   # Auth state notifier
└── features/
    └── auth/
        ├── login_screen.dart          # Login UI
        └── signup_screen.dart         # Sign up UI
```

---

## Key Components

### 1. Firebase Initialization

**Location:** `main.dart` (both apps)

```dart
void main() async {
  // Ensure Flutter binding is initialized before Firebase
  WidgetsFlutterBinding.ensureInitialized();

  // Initialize Firebase
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );

  runApp(
    const ProviderScope(
      child: YuvaApp(), // or YuvaWorkerApp
    ),
  );
}
```

### 2. User Model

**Location:** `lib/data/models/user.dart`

Represents an authenticated Firebase user with basic profile information:

```dart
class User {
  final String id;           // Firebase UID
  final String name;         // Display name
  final String email;        // Email address
  final String? photoUrl;    // Profile photo URL
  final String? phone;       // Phone number
  final DateTime createdAt;  // Account creation timestamp
}
```

**Note:** For yuva_worker, there's a separate `WorkerProfile` model for extended worker data (services, ratings, etc.) that will be stored in Firestore later.

### 3. Auth Repository Interface

**Location:** `lib/data/repositories/auth_repository.dart`

Abstract interface defining authentication operations:

```dart
abstract class AuthRepository {
  Future<User?> getCurrentUser();
  Future<User> signInWithEmail(String email, String password);
  Future<User> signUpWithEmail(String email, String password, String name);
  Future<void> signOut();
  Future<User> continueAsGuest();  // Only in yuva_client
}
```

### 4. Firebase Auth Repository Implementation

**Location:** `lib/data/repositories/firebase_auth_repository.dart`

Implements `AuthRepository` using Firebase Authentication:

**Key Features:**

- Email/password authentication
- Anonymous authentication (guest mode - client app only)
- Display name updates
- User mapping from Firebase User to app User model
- Spanish error message mapping for better UX

**Error Handling:**
Maps Firebase error codes to Spanish user-friendly messages:

- `user-not-found` → "No existe una cuenta con este correo electrónico"
- `wrong-password` → "Contraseña incorrecta"
- `email-already-in-use` → "Ya existe una cuenta con este correo electrónico"
- `weak-password` → "La contraseña debe tener al menos 6 caracteres"
- `network-request-failed` → "Error de conexión. Verifica tu internet"

### 5. Auth State Notifier

**Location:** `lib/data/repositories/auth_state_notifier.dart`

Manages authentication state using Riverpod's `StateNotifier`:

```dart
class AuthState {
  final User? user;
  final bool isLoading;
  final String? errorMessage;

  bool get isAuthenticated => user != null;
  bool get isAnonymous => user != null && user!.email.isEmpty;
}
```

Automatically listens to `FirebaseAuth.authStateChanges()` and updates the state when:

- User logs in
- User logs out
- User session changes
- App restarts (Firebase persists session automatically)

### 6. Riverpod Providers

**Location:** `lib/core/providers.dart`

**yuva_client providers:**

```dart
// Firebase Auth instance
final firebaseAuthProvider = Provider<FirebaseAuth>(...);

// Auth repository
final authRepositoryProvider = Provider<AuthRepository>(...);

// Auth state (listens to Firebase auth changes)
final authStateProvider = StateNotifierProvider<AuthStateNotifier, AuthState>(...);

// Current user (derived from authStateProvider)
final currentUserProvider = StateProvider<User?>(... watch authStateProvider);
```

**yuva_worker providers:** (same structure, plus worker-specific providers)

### 7. UI Screens

#### Login Screen

**Location:** `lib/features/auth/login_screen.dart`

- Email and password input fields
- Form validation
- Loading state during authentication
- Error display via SnackBar
- Navigation to signup screen
- Guest mode button (yuva_client only)
- Navigation to main screen on success

#### Signup Screen

**Location:** `lib/features/auth/signup_screen.dart`

- Name, email, and password input fields
- Form validation (min 6 chars for password)
- Loading state during registration
- Error display via SnackBar
- Navigation to login screen
- Automatic display name update
- Navigation to main screen on success

---

## Authentication Flow

### App Launch

```
1. App starts
2. Firebase.initializeApp() is called in main()
3. AuthStateNotifier subscribes to authStateChanges()
4. If user session exists:
   → User is logged in automatically
   → Navigate to /main (or show main content)
5. If no session:
   → Show login screen
```

### Login Flow

```
1. User enters email and password
2. Form validation
3. Call authRepository.signInWithEmail()
4. Firebase authenticates user
5. If success:
   → AuthStateNotifier updates state with User
   → currentUserProvider updates automatically
   → Navigate to /main
6. If error:
   → Show localized error message in SnackBar
```

### Signup Flow

```
1. User enters name, email, and password
2. Form validation (password ≥ 6 chars)
3. Call authRepository.signUpWithEmail()
4. Firebase creates user account
5. Update display name with provided name
6. Reload user to get updated data
7. If success:
   → AuthStateNotifier updates state with User
   → Navigate to /main
8. If error:
   → Show localized error message in SnackBar
```

### Guest Mode Flow (yuva_client only)

```
1. User taps "Continue as Guest"
2. Call authRepository.continueAsGuest()
3. Firebase signs in anonymously
4. If success:
   → AuthStateNotifier updates with anonymous user
   → Navigate to /main
   → User can browse services without full account
```

### Logout Flow

```
1. User taps logout (in profile/settings)
2. Call authRepository.signOut()
3. Firebase signs out user
4. AuthStateNotifier updates state (user = null)
5. App navigates back to /login
```

---

## Session Persistence

Firebase automatically persists authentication sessions:

- Sessions survive app restarts
- Sessions survive device reboots
- Sessions are stored securely in device keychain/keystore
- No manual session management required

**To clear session:**

- Call `signOut()` programmatically
- User uninstalls app
- User clears app data

---

## Security Considerations

1. **Passwords:**

   - Minimum 6 characters enforced by Firebase
   - Passwords are never stored locally
   - Passwords are hashed and managed by Firebase

2. **Email Validation:**

   - Emails are trimmed before authentication
   - Firebase validates email format
   - Email verification can be added later

3. **Error Messages:**

   - Error messages are user-friendly
   - No sensitive information exposed in errors
   - Spanish localization for better UX

4. **Auth Tokens:**

   - Managed automatically by Firebase SDK
   - Securely stored in device keychain/keystore
   - Automatically refreshed by Firebase

5. **Network Security:**
   - All Firebase communication uses HTTPS
   - Tokens are encrypted in transit

---

## Future Enhancements

### Planned Features

- [ ] Email verification after registration
- [ ] Password reset via email
- [ ] Phone number authentication
- [ ] Social login (Google, Apple)
- [ ] Multi-factor authentication (MFA)
- [ ] Custom claims for role-based access (client vs worker)
- [ ] Integration with Firestore for user profiles
- [ ] Profile photo upload
- [ ] Account deletion

### Worker App Specific

- [ ] Admin approval for worker accounts
- [ ] Worker profile setup after registration
- [ ] Background check integration
- [ ] Verification badge system

---

## Testing

See `docs/auth-checklist-flutter.md` for comprehensive testing checklist.

### Quick Test Commands

**Run yuva_client:**

```bash
cd yuva_client
flutter run
```

**Run yuva_worker:**

```bash
cd yuva_worker
flutter run
```

**Test credentials (create via signup screen):**

- Client: testclient@example.com / password123
- Worker: testworker@example.com / password123

---

## Troubleshooting

### Common Issues

**Issue:** Firebase not initialized

- **Solution:** Ensure `Firebase.initializeApp()` is called in `main()` before `runApp()`

**Issue:** Auth state not updating

- **Solution:** Ensure providers are being watched with `ref.watch()`, not `ref.read()`

**Issue:** "DefaultFirebaseOptions not found"

- **Solution:** Run `flutterfire configure` to regenerate `firebase_options.dart`

**Issue:** Login works but user gets logged out on restart

- **Solution:** Check that Firebase persistence is enabled (enabled by default in Flutter)

**Issue:** Wrong error messages displayed

- **Solution:** Check `_mapFirebaseException()` in `firebase_auth_repository.dart`

---

## References

- [Firebase Auth Documentation](https://firebase.google.com/docs/auth)
- [FlutterFire Documentation](https://firebase.flutter.dev/docs/auth/overview)
- [Riverpod Documentation](https://riverpod.dev)
- [Flutter Best Practices](https://flutter.dev/docs/development/data-and-backend/state-mgmt/options)

---

**Last Updated:** November 21, 2025  
**Authors:** GitHub Copilot + Development Team  
**Version:** 1.0.0
